####################################################################
#							Sequence Match
####################################################################

begin sequence prematch_jaune
call auto_test
call prematch_common
call slider_range_gauche
propulsion.set_pose start_pose_jaune
end sequence

begin sequence prematch_violet
call auto_test
call prematch_common
call slider_range_droite
propulsion.set_pose start_pose_violet
end sequence

############################ match jaune #####################

begin sequence match_jaune
propulsion.set_pose start_pose_jaune
#--prise palet devant rouge
call preprise_sol
propulsion.move_to palet_zone_rouge_jaune,speed_500
wait_movement_finished
call prise_sol_av
propulsion.point_to palet_zone_verte_jaune,yaw_180
call stocke_palet_av_g
delay delay02
wait_movement_finished
#--prise palet devant vert
call preprise_sol
propulsion.move_to palet_zone_verte_jaune,speed_500
wait_movement_finished
call prise_sol_av
propulsion.move_to palet_zone_bleu_jaune,speed_500
call stocke_palet_av_d
delay delay02
#--prise palet devant bleu
call preprise_sol
wait_movement_finished
call prise_sol_ar

#--voyage a accelerateur
propulsion.point_to debut_recal_acc_jaune,yaw_180
wait_movement_finished
propulsion.move_to debut_recal_acc_jaune,speed_500
call stocke_palet_ar_g
delay delay02
wait_movement_finished
call griffes_accelerateur_jaune
call recale_accelerateur_jaune

#wait_movement_finished 
#propulsion.point_to contact_acc_jaune,yaw_180
#prepositionnement pour prise acc
arm.go_to_position acc_depose,1,100
#wait_movement_finished
propulsion.move_to contact_acc_jaune,speed_200
wait_movement_finished

#--declenchement accelerateur
#arm.go_to_position acc_tassage,1,100
#delay delay05
#call slider_pousse_droite
#delay delay02

#--prise accelerateur
call prise_palet_accelerateur

#--depose accelerateur
call destock_palet_ar_g
call accelerateur_jaune
delay delay02
call destock_palet_av_d
call accelerateur_jaune
delay delay02
call destock_palet_av_g
call accelerateur_jaune
delay delay02

#--voyage goldenium
propulsion.move_to approche_acc_jaune,speed_500
wait_movement_finished
propulsion.point_to approche_gold_jaune,yaw_180
propulsion.move_to approche_gold_jaune,speed_500
call griffes_goldenium
call slider_range_droite
wait_movement_finished
propulsion.point_to contact_gold_jaune,yaw_180
propulsion.move_to contact_gold_jaune,speed_200
wait_movement_finished

#--prise goldenium
call prise_goldenium
propulsion.move_to approche_gold_jaune,speed_500
wait_movement_finished
call griffes_range

#--voyage vers balance
propulsion.point_to virage_face_balance_chaos_jaune,yaw_180
wait_movement_finished
propulsion.move_to virage_face_balance_chaos_jaune,speed_500
wait_movement_finished
propulsion.point_to depose_balance_jaune,yaw_180
wait_movement_finished
propulsion.move_to depose_balance_jaune,speed_500
wait_movement_finished

#--depose balance
call jette_palet
delay delay02
call destock_palet_ar_d
delay delay02
call jette_palet

#--trajet au distrib1
propulsion.move_to debut_recal_balance_jaune,speed_200
######### instruction pour mettre de dos, à remplacer #####
propulsion.point_to debut_recal_balance_violet,yaw_180
wait_movement_finished
################## todo - recalage balance ici ##################
propulsion.move_to approche_distrib1_jaune,speed_500
wait_movement_finished

#--prise distrib1
propulsion.point_to contact_distrib1_jaune,yaw_180
call preprise_dist
set_servo griffe_g,servo_griffe_gauche_attack,100
wait_movement_finished
propulsion.move_to contact_distrib1_jaune,speed_200
wait_movement_finished
call prise_dist_ar
#--recul distrib1
propulsion.move_to approche_distrib1_jaune,speed_500
set_servo griffe_g,servo_griffe_gauche_retrait,100
call stocke_palet_ar_d
wait_movement_finished
propulsion.point_to fin_ligne_chaos_jaune,yaw_180
call preprise_sol
wait_movement_finished fin_ligne_chaos_jaune

#--ligne collecte chaos
call prise_ligne_chaos

#--collecte chaos
#propulsion.move_to approche_chaos_jaune,speed_500
#wait_movement_finished
#propulsion.point_to depose_zone_verte_rouge_jaune,yaw_180
#wait_movement_finished
#call griffes_chaos
#propulsion.move_to depose_zone_verte_rouge_jaune,speed_500
#call preprise_sol
#wait_movement_finished
#call griffes_range

#--recuperation 1 palet
#call prise_sol_av
#propulsion.move_to approche_chaos_jaune,speed_500
#wait_movement_finished
#propulsion.point_to depose_balance_jaune,yaw_180
#wait_movement_finished
#propulsion.move_to depose_balance_jaune,speed_500
#wait_movement_finished
#call jette_palet

end sequence


############################ match violet #####################

begin sequence match_violet
propulsion.set_pose start_pose_violet
#--prise palet devant rouge
call preprise_sol
propulsion.move_to palet_zone_rouge_violet,speed_500
wait_movement_finished
call prise_sol_av
propulsion.point_to palet_zone_verte_violet,yaw_180
call stocke_palet_av_g
delay delay02
wait_movement_finished
#--prise palet devant vert
call preprise_sol
propulsion.move_to palet_zone_verte_violet,speed_500
wait_movement_finished
call prise_sol_av
propulsion.move_to palet_zone_bleu_violet,speed_500
call stocke_palet_av_d
delay delay02
#--prise palet devant bleu
call preprise_sol
wait_movement_finished
call prise_sol_ar

#--voyage a accelerateur
#propulsion.point_to virage_top_chaos_violet,yaw_180
#wait_movement_finished
#propulsion.move_to virage_top_chaos_violet,speed_500
propulsion.point_to approche_acc_violet,yaw_180
wait_movement_finished
propulsion.move_to approche_acc_violet,speed_500
call stocke_palet_ar_g
delay delay02
call griffes_accelerateur_violet
#wait_movement_finished
wait_movement_finished
#propulsion.point_to virage_face_acc_advchaos_violet,yaw_180
#wait_movement_finished
#propulsion.move_to virage_face_acc_advchaos_violet,speed_500
#wait_movement_finished
#propulsion.point_to approche_acc_violet,yaw_180
#wait_movement_finished
#propulsion.move_to approche_acc_violet,speed_500
#wait_movement_finished
propulsion.point_to contact_acc_violet,yaw_180
wait_movement_finished
propulsion.move_to contact_acc_violet,speed_200
wait_movement_finished
#--declenchement accelerateur
arm.go_to_position acc_tassage2,1,100
wait_arm_finished
delay delay02
call slider_pousse_gauche
delay delay05
call slider_range_droite
delay delay05
#--depose accelerateur
call destock_palet_ar_g
call accelerateur_violet
delay delay02
call destock_palet_av_d
call accelerateur_violet
delay delay02
call destock_palet_av_g
call accelerateur_violet
delay delay02
#--voyage goldenium
propulsion.move_to approche_acc_violet,speed_500
wait_movement_finished
call griffes_range
propulsion.point_to approche_gold_violet,yaw_180
wait_movement_finished
propulsion.move_to approche_gold_violet,speed_500
wait_movement_finished
call griffes_goldenium
call slider_range_gauche
propulsion.point_to contact_gold_violet,yaw_180
wait_movement_finished
propulsion.move_to contact_gold_violet,speed_200
wait_movement_finished
#--prise goldenium
call prise_goldenium
propulsion.move_to approche_gold_violet,speed_500
wait_movement_finished
call griffes_range
#--voyage vers balance
#propulsion.point_to virage_face_gold_advchaos_violet,yaw_180
#wait_movement_finished
#propulsion.move_to virage_face_gold_advchaos_violet,speed_500
#wait_movement_finished
propulsion.point_to virage_face_balance_chaos_violet,yaw_180
wait_movement_finished
propulsion.move_to virage_face_balance_chaos_violet,speed_500
wait_movement_finished
propulsion.point_to depose_balance_violet,yaw_180
wait_movement_finished
propulsion.move_to depose_balance_violet,speed_500
wait_movement_finished
#--depose balance
call jette_palet
delay delay1
#collecte chaos
propulsion.move_to approche_chaos_violet,speed_500
wait_movement_finished
propulsion.point_to depose_zone_verte_rouge_violet,yaw_180
wait_movement_finished
call griffes_chaos
propulsion.move_to depose_zone_verte_rouge_violet,speed_500
wait_movement_finished
call griffes_range
end sequence


begin sequence postmatch
propulsion.disable
propulsion.motors_disable
end sequence

begin sequence prematch_common
pump.set_pwm pwm_pump_off
set_servo stock_g,chargeur_gauche_sorti,100
set_servo stock_d,chargeur_droit_sorti,100
arm.go_to_position stk_av_retrait,1,100
call griffes_range
delay delay1
propulsion.motors_enable
propulsion.enable
end sequence

####################################################################
#							Sequence test
####################################################################

begin sequence test_propulsion
var float test_distance=400mm
var float test_angle=90deg
propulsion.motors_enable
propulsion.enable
propulsion.rotate test_angle,yaw_180
propulsion.translate test_distance,yaw_180
end sequence

begin sequence test_trajectoire_courbe
propulsion.trajectory traj_courbe1,4,speed_750
wait_movement_finished
propulsion.point_to fin_recal_acc_jaune,yaw_180
end sequence

begin sequence auto_test
#--test bras
call prise_sol_av
delay delay05
#--test stock
set_servo stock_d,chargeur_droit_prise,100
delay delay05
set_servo stock_d,chargeur_droit_sorti,100
delay delay02
set_servo stock_g,chargeur_gauche_prise,100
delay delay05
set_servo stock_g,chargeur_gauche_sorti,100
#--test pompe
pump.set_pwm pwm_pump_activated
delay delay1
pump.set_pwm pwm_pump_off
#--test slider
call slider_range_gauche
delay delay02
call slider_range_droite
delay delay02
#--test Cose
call griffes_chaos
delay delay05
call griffes_range
end sequence

begin sequence test_prise_distrib1_jaune
#--trajet au distrib1
propulsion.point_to approche_distrib1_jaune,yaw_180
wait_movement_finished
propulsion.move_to approche_distrib1_jaune,speed_500
wait_movement_finished

#--arrive devant le distrib1
propulsion.point_to contact_distrib1_jaune,yaw_180
call preprise_dist
set_servo griffe_g,servo_griffe_gauche_attack,100
wait_movement_finished
propulsion.move_to contact_distrib1_jaune,speed_200
wait_movement_finished
call prise_dist_ar
#--recul
propulsion.move_to approche_distrib1_jaune,speed_500
set_servo griffe_g,servo_griffe_gauche_retrait,100
call stocke_palet_ar_d
wait_movement_finished
propulsion.point_to fin_ligne_chaos_jaune,yaw_180
call preprise_sol
wait_movement_finished
#--ligne
call prise_ligne_chaos
end sequence


####################################################################
#							Sous-sequence
####################################################################

begin sequence preprise_sol
arm.go_to_position sol_preprise_intermediaire1,1,100
wait_arm_finished
arm.go_to_position sol_preprise_intermediaire2,1,100
wait_arm_finished
arm.go_to_position sol_preprise,1,100
wait_arm_finished
end sequence

begin sequence prise_sol_av
pump.set_pwm pwm_pump_activated
arm.go_to_position sol_prise,1,75
wait_arm_finished
delay delay05
arm.go_to_position stk_av_prise,1,75
wait_arm_finished
delay delay05
end sequence

begin sequence prise_sol_av_v2
pump.set_pwm pwm_pump_activated
arm.go_to_position sol_prise,1,75
wait_arm_finished
delay delay05
arm.go_to_position sol_postprise,1,60
wait_arm_finished
delay delay02
arm.go_to_position stk_av_prise,1,100
wait_arm_finished
delay delay05
end sequence

begin sequence prise_sol_ar
pump.set_pwm pwm_pump_activated
arm.go_to_position sol_prise,1,75
wait_arm_finished
delay delay05
arm.go_to_position stk_av_prise,1,75
wait_arm_finished
delay delay02
arm.go_to_position stk_ar_prise,1,75
wait_arm_finished
delay delay05
end sequence

begin sequence preprise_dist
arm.go_to_position dist_preprise,1,100
wait_arm_finished
end sequence

begin sequence prise_dist_ar
pump.set_pwm pwm_pump_activated
arm.go_to_position dist_prise,1,75
wait_arm_finished
delay delay05
arm.go_to_position dist_preprise,1,75
wait_arm_finished
arm.go_to_position stk_av_prise,1,75
wait_arm_finished
delay delay02
arm.go_to_position stk_ar_prise,1,75
wait_arm_finished
delay delay05
end sequence

begin sequence prise_palet_accelerateur
arm.go_to_position acc_depose,1,100
wait_arm_finished
pump.set_pwm pwm_pump_activated
delay delay02
arm.go_to_position stk_ar_retrait,1,100
wait_arm_finished
delay delay02
call stocke_palet_ar_d
delay delay02
arm.go_to_position stk_av_retrait,1,100
end sequence

begin sequence prise_goldenium
arm.go_to_position gold_preprise,1,100
wait_arm_finished
arm.go_to_position gold_prise,1,100
wait_arm_finished
pump.set_pwm pwm_pump_activated
delay delay1
arm.go_to_position gold_stockage_intermediaire1,1,20
wait_arm_finished
arm.go_to_position gold_stockage_intermediaire2,1,20
wait_arm_finished
arm.go_to_position gold_stockage,1,20
wait_arm_finished
end sequence

begin sequence jette_palet
arm.go_to_position gold_prise,1,100
delay delay005
pump.set_pwm pwm_pump_off
end sequence

begin sequence depose_sol
arm.go_to_position sol_preprise_intermediaire1,1,100
wait_arm_finished
arm.go_to_position sol_preprise_intermediaire2,1,100
wait_arm_finished
arm.go_to_position sol_preprise,1,100
wait_arm_finished
delay delay02
pump.set_pwm pwm_pump_off
end sequence

begin sequence vidange_stock
arm.go_to_position stk_av_retrait,1,100
delay delay05
call destock_palet_av_g
call jette_palet
arm.go_to_position stk_av_retrait,1,100
delay delay05
call destock_palet_av_d
call jette_palet
arm.go_to_position stk_ar_retrait,1,100
delay delay05
call destock_palet_ar_g
call jette_palet
arm.go_to_position stk_ar_retrait,1,100
delay delay05
call destock_palet_ar_d
call jette_palet
arm.go_to_position stk_av_retrait,1,100
end sequence

begin sequence slider_pousse_gauche
set_servo slider,servo_slider_droit_presorti,100
delay delay02
set_servo slider,servo_slider_gauche,100
delay delay05
call slider_range_droite
end sequence

begin sequence slider_pousse_droite
set_servo slider,servo_slider_gauche_presorti,100
delay delay02
set_servo slider,servo_slider_droite,100
delay delay05
call slider_range_gauche
end sequence

begin sequence slider_range_gauche
set_servo slider,servo_slider_gauche_overshoot,100
delay delay05
set_servo slider,servo_slider_gauche_range,100
delay delay02
end sequence

begin sequence slider_range_droite
set_servo slider,servo_slider_droit_overshoot,100
delay delay05
set_servo slider,servo_slider_droit_range,100
delay delay02
end sequence

begin sequence stocke_palet_av_d
arm.go_to_position stk_av_prise,1,100
wait_arm_finished
set_servo stock_d,chargeur_droit_preprise,100
delay delay02
arm.go_to_position stk_av_tasse,1,100
wait_arm_finished
delay delay02
set_servo stock_d,chargeur_droit_prise,100
delay delay05
pump.set_pwm pwm_pump_off
delay delay02
arm.go_to_position stk_av_retrait,1,100
wait_arm_finished
set_servo stock_d,chargeur_droit_sorti,100
delay delay05
end sequence

begin sequence stocke_palet_ar_g
arm.go_to_position stk_ar_prise,1,100
wait_arm_finished
set_servo stock_g,chargeur_gauche_preprise,100
delay delay02
arm.go_to_position stk_ar_tasse,1,100
wait_arm_finished
delay delay02
set_servo stock_g,chargeur_gauche_prise,100
delay delay05
pump.set_pwm pwm_pump_off
delay delay02
arm.go_to_position stk_ar_retrait,1,100
wait_arm_finished
set_servo stock_g,chargeur_gauche_sorti,100
delay delay05
end sequence

begin sequence stocke_palet_ar_d
arm.go_to_position stk_ar_prise,1,100
wait_arm_finished
set_servo stock_d,chargeur_droit_preprise,100
delay delay02
arm.go_to_position stk_ar_tasse,1,100
wait_arm_finished
delay delay02
set_servo stock_d,chargeur_droit_prise,100
delay delay05
pump.set_pwm pwm_pump_off
delay delay02
arm.go_to_position stk_ar_retrait,1,100
wait_arm_finished
set_servo stock_d,chargeur_droit_sorti,100
delay delay05
end sequence

begin sequence destock_palet_av_g
arm.go_to_position stk_av_retrait,1,100
wait_arm_finished
delay delay02
set_servo stock_g,chargeur_gauche_prise,100
delay delay1
arm.go_to_position stk_av_tasse,1,100
wait_arm_finished
pump.set_pwm pwm_pump_activated
delay delay05
arm.go_to_position stk_av_prise,1,75
wait_arm_finished
set_servo stock_g,chargeur_gauche_sorti,100
#--stock vide:
movi status_stock_av_g,0
delay delay05


end sequence

begin sequence destock_palet_av_d
arm.go_to_position stk_av_retrait,1,100
wait_arm_finished
delay delay02
set_servo stock_d,chargeur_droit_prise,100
delay delay1
arm.go_to_position stk_av_tasse,1,100
wait_arm_finished
pump.set_pwm pwm_pump_activated
delay delay05
arm.go_to_position stk_av_prise,1,75
wait_arm_finished
set_servo stock_d,chargeur_droit_sorti,100
delay delay05
#--stock vide:
movi status_stock_av_d,0
end sequence

begin sequence destock_palet_ar_g
arm.go_to_position stk_ar_retrait,1,100
wait_arm_finished
delay delay02
set_servo stock_g,chargeur_gauche_prise,100
delay delay1
arm.go_to_position stk_ar_tasse,1,100
wait_arm_finished
pump.set_pwm pwm_pump_activated
delay delay05
arm.go_to_position stk_ar_prise,1,75
wait_arm_finished
set_servo stock_g,chargeur_gauche_sorti,100
delay delay05
#--stock vide:
movi status_stock_ar_g,0
end sequence

begin sequence destock_palet_ar_d
arm.go_to_position stk_ar_retrait,1,100
wait_arm_finished
delay delay02
set_servo stock_d,chargeur_droit_prise,100
delay delay1
arm.go_to_position stk_ar_tasse,1,100
wait_arm_finished
pump.set_pwm pwm_pump_activated
delay delay05
arm.go_to_position stk_ar_prise,1,75
wait_arm_finished
set_servo stock_d,chargeur_droit_sorti,100
delay delay05
#--stock vide:
movi status_stock_ar_d,0
end sequence

begin sequence acc_depose
#--prereq: Cose sortie, palet ventouse
arm.go_to_position acc_pre_depose,1,100
wait_arm_finished
arm.go_to_position acc_depose,1,75
wait_arm_finished
delay delay02
pump.set_pwm pwm_pump_off
delay delay02
end sequence

begin sequence tasse_accelerateur
#--unused: remplace par une position unique
arm.go_to_position acc_pre_tassage,1,75
wait_arm_finished
delay delay05
arm.go_to_position acc_tassage,1,75
wait_arm_finished
end sequence

begin sequence accelerateur_violet
#--prereq: Cose sortie, palet ventouse
call acc_depose
delay delay02
arm.go_to_position acc_tassage2,1,100
wait_arm_finished
delay delay02
call slider_pousse_gauche
arm.go_to_position stk_av_prise,1,100
wait_arm_finished
end sequence

begin sequence accelerateur_jaune
#--prereq: Cose sortie, palet ventouse
call acc_depose
delay delay02
arm.go_to_position acc_tassage2,1,100
wait_arm_finished
delay delay02
call slider_pousse_droite
arm.go_to_position stk_av_prise,1,100
wait_arm_finished
end sequence

begin sequence griffes_goldenium
set_servo griffe_g,servo_griffe_gauche_goldenium,100
set_servo griffe_d,servo_griffe_droit_goldenium,100
end sequence

begin sequence griffes_range
set_servo griffe_g,servo_griffe_gauche_retrait,100
set_servo griffe_d,servo_griffe_droit_retrait,100
end sequence

begin sequence griffes_accelerateur_violet
set_servo griffe_d,servo_griffe_droit_accelerateur,100
set_servo griffe_g,servo_griffe_gauche_retrait,100
end sequence

begin sequence griffes_accelerateur_jaune
set_servo griffe_g,servo_griffe_gauche_accelerateur,100
set_servo griffe_d,servo_griffe_droit_retrait,100
end sequence

begin sequence griffes_chaos
set_servo griffe_g,servo_griffe_gauche_attack,100
set_servo griffe_d,servo_griffe_droit_attack,100
end sequence

####################################################################
#							Sequence recalage
####################################################################

begin sequence recale_accelerateur_jaune
#--set position pour test recalage
#propulsion.motors_enable
#propulsion.enable
#propulsion.set_pose debut_recal_acc_jaune
#delay delay02
propulsion.point_to fin_recal_acc_jaune,yaw_180
wait_movement_finished
delay delay1
propulsion.move_to fin_recal_acc_jaune,speed_200
#--boucle de surveillance capteur lateral
label boucle_recalage_acc_jaune
check_sensor rouge_droit
yield
jz boucle_recalage_acc_jaune

#--sortie boucle capteur
propulsion.measure_point rouge_lateral,capteur_recal_acc_jaune
wait_movement_finished
propulsion.move_to approche_acc_jaune,speed_200
wait_movement_finished
propulsion.point_to contact_acc_jaune,yaw_180
wait_movement_finished
end sequence

begin sequence recale_accelerateur_jaune_v2
#--set position pour test recalage
#propulsion.motors_enable
#propulsion.enable
#propulsion.set_pose debut_recal_acc_jaune
#delay delay02
propulsion.point_to fin_recal_acc_jaune,yaw_180
wait_movement_finished
delay delay1
propulsion.move_to fin_recal_acc_jaune,speed_200

#--boucle de surveillance capteur lateral
label boucle_recalage_acc
	check_sensor rouge_droit
	jnz fin_boucle_recalage_acc
		check_propulsion_state 1
		je fin_ligne_recalage_acc_atteinte
	yield
jmp boucle_recalage_acc

#--sortie boucle capteur
label fin_boucle_recalage_acc
propulsion.measure_point rouge_lateral,capteur_recal_acc_jaune
wait_movement_finished

#--fin de trajectoire atteinte
label fin_ligne_recalage_acc_atteinte
propulsion.move_to approche_acc_jaune,speed_200
wait_movement_finished
propulsion.point_to contact_acc_jaune,yaw_180
wait_movement_finished
end sequence

begin sequence recale_accelerateur_violet
#propulsion.set_pose preapproche_acc_violet
#propulsion.move_to approche_acc_violet,test_approche_speeds
#label boucle_recalage_acc_violet
#check_sensor rouge_droit
#jz boucle_recalage_acc_violet
#propulsion.set_pose approche_acc_violet
#wait_movement_finished
propulsion.point_to contact_acc_violet,yaw_180
wait_movement_finished
end sequence


####################################################################
#							Sequence collecte chaos
####################################################################


begin sequence prise_ligne_chaos
#--prereq: palet distrib1 stocke en stock_ar_d
call griffes_chaos
propulsion.move_to fin_ligne_chaos_jaune,speed_100

#--palet 1
call prise_auto_av
call stocke_palet_av_d

#--palet 2
call preprise_sol
call prise_auto_av
call stocke_palet_av_g

#--palet 3
call preprise_sol
call prise_auto_ar
call stocke_palet_ar_g

wait_movement_finished
propulsion.move_to debut_recal_acc_jaune,speed_200
delay delay1
call griffes_range

#--palet 4
call preprise_sol
call prise_auto_av
#--on garde un palet sur la ventouse

wait_movement_finished
end sequence

begin sequence prise_auto_av
label boucle_palet
	check_sensor micro_switch
	yield
jz boucle_palet
call prise_sol_av
end sequence

begin sequence prise_auto_ar
label boucle_palet
	check_sensor micro_switch
	yield
jz boucle_palet
call prise_sol_ar
end sequence

begin sequence debug
call preprise_sol
call prise_sol_av
call stocke_palet_av_g
delay delay02
#--prise palet devant vert
call preprise_sol
call prise_sol_av
call stocke_palet_av_d
delay delay02
#--prise palet devant bleu
call preprise_sol
call prise_sol_ar
call stocke_palet_ar_g
delay delay02
#--voyage a l'accel
call griffes_accelerateur_violet
#declenchement accelerateur
arm.go_to_position acc_tassage2,1,100
wait_arm_finished
delay delay02
call slider_pousse_droite
delay delay05
call slider_range_gauche
#depose accelerateur
call destock_palet_ar_g
call accelerateur_violet
delay delay02
call destock_palet_av_d
call accelerateur_violet
delay delay02
call destock_palet_av_g
call accelerateur_violet
delay delay02
end sequence

####################################################################
#							Sequence a tester
####################################################################

var int oui=1
var int nb_palet_a_collecter=0
var int nb_palet_en_stock=0
var int max_palet_en_stock=5
var int garder_dernier_palet_prit_sur_ventouse=0
var int palet_tombe_dans_robot=0
var int status_stock_av_d=0
var int status_stock_av_g=0
var int status_stock_ar_d=0
var int status_stock_ar_g=0
var int status_ventouse=0

begin sequence stocke_palet_av_g
arm.go_to_position stk_av_prise,1,100
wait_arm_finished
set_servo stock_g,chargeur_gauche_preprise,100
delay delay02
arm.go_to_position stk_av_tasse,1,100
wait_arm_finished
delay delay02
set_servo stock_g,chargeur_gauche_prise,100
delay delay05

#--test de la presence du palet avant depose
call update_status_ventouse
cmp status_ventouse,oui
jne palet_ventouse

#--si palet perdu
movi status_stock_av_g,0
call debourrage_palet_dans_robot
jump fin_depose

#--si palet toujours présent, on enregistre le bon depot
label palet_ventouse
movi status_stock_av_g,1

#--on termine le depot du palet
label fin_depose
pump.set_pwm pwm_pump_off
delay delay02
arm.go_to_position stk_av_retrait,1,100
wait_arm_finished
set_servo stock_g,chargeur_gauche_sorti,100
delay delay05
end sequence

#-- + tester destock

begin sequence stock_auto
#--fonction sortante sur une arrive en fin de deplacement
#--on stock en priorité av puis ar.
#--ne pas oublier de lire le flag "garder_dernier_palet_prit_sur_ventouse" pour savoir si on garde le palet sur la ventouse
#--todo
end sequence

begin sequence destock_auto
#--todo
#--1) test si palet dans ventouse, pas de déstockage
#--2) test si stock av_g
#--3) test si stock av_d
#--4) test si stock ar_g
#--5) test si stock ar_d

end sequence

begin sequence debourrage_palet_dans_robot
movi palet_tombe_dans_robot,1
#--todo - que faire pour debourrer??
end sequence

begin sequence update_status_ventouse
#--test de l'etat du vacuostat
check_sensor vacuostat
jz palet_present
#--palet present
label palet_present
movi status_ventouse,1
jmp fin_sequence
#--pas de palet
movi status_ventouse,0
label fin_sequence
end sequence

begin sequence update_nb_palet_en_stock
#--comptage local
var int cmp_palet_en_stock=0
#--recuperation des status
addi cmp_palet_en_stock,status_stock_av_d
addi cmp_palet_en_stock,status_stock_av_g
addi cmp_palet_en_stock,status_stock_ar_d
addi cmp_palet_en_stock,status_stock_ar_g
addi cmp_palet_en_stock,status_ventouse
#--on verifie que l'on a pas plus de palet que possible
cmp  cmp_palet_en_stock,max_palet_en_stock
jne nombre_max_non_atteint
#--nombre max atteint, on limite à 5
movi cmp_palet_en_stock,5
#--on recopie le compte local dans le compte global
label nombre_max_non_atteint
mov1 nb_palet_en_stock,cmp_palet_en_stock
end sequence

begin sequence prise_ligne_chaos_v2
#--prereq: palet distrib1 stocke en stock_ar_d
call griffes_chaos
propulsion.move_to fin_ligne_chaos_jaune,speed_100

#--palet 1
call prise_auto_av
call stocke_palet_av_d

#--palet 2
call preprise_sol
call prise_auto_av
call stocke_palet_av_g

#--palet 3
call preprise_sol
call prise_auto_ar
call stocke_palet_ar_g

wait_movement_finished
propulsion.move_to debut_recal_acc_jaune,speed_200
delay delay1
call griffes_range

#--palet 4
call preprise_sol
call prise_auto_av
#--on garde un palet sur la ventouse

wait_movement_finished
end sequence
